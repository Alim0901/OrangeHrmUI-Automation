name: Playwright-CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Java 24
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24-ea'
          check-latest: true

      # 3Ô∏è‚É£ Cache Maven repository
      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      # 4Ô∏è‚É£ Install Playwright browsers and dependencies
      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps

      # 4Ô∏è‚É£ Run tests and generate Allure report
      - run: mvn clean verify

      # 5Ô∏è‚É£ Upload Allure HTML report as artifact
      - name: Archive Allure HTML report
        uses: actions/upload-artifact@v4
        with:
          name: allure-html
          path: target/site/allure-maven-plugin

  publish-pages:
    needs: test
    if: always
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      # 1Ô∏è‚É£ Download Allure HTML report artifact
      - uses: actions/download-artifact@v4
        with:
          name: allure-html
          path: public

      # 2Ô∏è‚É£ Configure GitHub Pages
      - uses: actions/configure-pages@v5

      # 3Ô∏è‚É£ Upload pages artifact
      - uses: actions/upload-pages-artifact@v3
        with:
          path: public

      # 4Ô∏è‚É£ Deploy to GitHub Pages
      - uses: actions/deploy-pages@v4

      # 5Ô∏è‚É£ Comment PR with report link
      - name: Comment with report link
        if: ${{ github.event_name == 'pull_request' }}
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ‚úÖ **Allure Report is Ready!**
            üîó [View Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)